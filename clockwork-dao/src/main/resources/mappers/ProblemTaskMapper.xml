<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.creditease.adx.clockwork.dao.mapper.ProblemTaskMapper">

    <resultMap id="BaseResultMap" type="com.creditease.adx.clockwork.common.entity.gen.TbClockworkTask">
        <!--
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="alias_name" jdbcType="VARCHAR" property="aliasName"/>
        <result column="description" jdbcType="VARCHAR" property="description"/>
        <result column="dag_id" jdbcType="INTEGER" property="dagId"/>
        <result column="group_id" jdbcType="INTEGER" property="groupId"/>
        <result column="node_gid" jdbcType="INTEGER" property="nodeGid"/>
        <result column="location" jdbcType="VARCHAR" property="location"/>
        <result column="script_name" jdbcType="VARCHAR" property="scriptName"/>
        <result column="script_type" jdbcType="VARCHAR" property="scriptType"/>
        <result column="script_parameter" jdbcType="VARCHAR" property="scriptParameter"/>
        <result column="command" jdbcType="VARCHAR" property="command"/>
        <result column="parameter" jdbcType="VARCHAR" property="parameter"/>
        <result column="trigger_mode" jdbcType="INTEGER" property="triggerMode"/>
        <result column="cron_exp" jdbcType="VARCHAR" property="cronExp"/>
        <result column="trigger_time" jdbcType="TIMESTAMP" property="triggerTime"/>
        <result column="next_trigger_time" jdbcType="TIMESTAMP" property="nextTriggerTime"/>
        <result column="time_type" jdbcType="VARCHAR" property="timeType"/>
        <result column="run_frequency" jdbcType="INTEGER" property="runFrequency"/>
        <result column="dependency_id" jdbcType="VARCHAR" property="dependencyId"/>
        <result column="expired_time" jdbcType="TIMESTAMP" property="expiredTime"/>
        <result column="failed_retries" jdbcType="INTEGER" property="failedRetries"/>
        <result column="status" jdbcType="VARCHAR" property="status"/>
        <result column="delay_status" jdbcType="INTEGER" property="delayStatus"/>
        <result column="online" jdbcType="BIT" property="online"/>
        <result column="last_start_time" jdbcType="TIMESTAMP" property="lastStartTime"/>
        <result column="last_end_time" jdbcType="TIMESTAMP" property="lastEndTime"/>
        <result column="run_timeout" jdbcType="INTEGER" property="runTimeout"/>
        <result column="run_engine" jdbcType="VARCHAR" property="runEngine"/>
        <result column="is_private" jdbcType="BIT" property="isPrivate"/>
        <result column="is_first" jdbcType="BIT" property="isFirst"/>
        <result column="is_sync_file" jdbcType="BIT" property="isSyncFile"/>
        <result column="is_replace" jdbcType="BIT" property="isReplace"/>
        <result column="source" jdbcType="INTEGER" property="source"/>
        <result column="proxy_user" jdbcType="VARCHAR" property="proxyUser"/>
        <result column="batch_number" jdbcType="BIGINT" property="batchNumber"/>
        <result column="business_info" jdbcType="VARCHAR" property="businessInfo"/>
        <result column="create_user" jdbcType="VARCHAR" property="createUser"/>
        <result column="operator_name" jdbcType="VARCHAR" property="operatorName"/>
        <result column="email_list" jdbcType="VARCHAR" property="emailList"/>
        <result column="create_time" jdbcType="TIMESTAMP" property="createTime"/>
        <result column="update_time" jdbcType="TIMESTAMP" property="updateTime"/>
    </resultMap>

    <sql id="Base_Column_List">
        <!--
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        id, `name`, alias_name, description, dag_id, group_id, node_gid, `location`, script_name,
        script_type, script_parameter, command, `parameter`, trigger_mode, cron_exp, trigger_time,
        next_trigger_time, time_type, run_frequency, dependency_id, expired_time, failed_retries,
        `status`, delay_status, `online`, last_start_time, last_end_time, run_timeout, run_engine,
        is_private, is_first, is_sync_file, is_replace, `source`, proxy_user, batch_number,
        business_info, create_user, operator_name, email_list, create_time, update_time
    </sql>

    <!-- 查询任务中无效的dagId信息（dag信息早已经不存在） -->
    <select id="selectTaskInvalidDagId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tb_clockwork_task
        WHERE online=1
        AND NOT EXISTS (SELECT 1 FROM tb_clockwork_dag d WHERE dag_id = d.id)
    </select>

    <!-- 查询任务中无效的触发条件 -->
    <select id="selectTaskInvalidTriggerCondition" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM tb_clockwork_task t
        WHERE t.online=1
        AND (
        (t.trigger_mode=1 and t.cron_exp is null)
        OR (t.trigger_mode=0 and NOT EXISTS (SELECT 1 FROM tb_clockwork_task_relation r WHERE r.task_id = t.id and r.is_effective=1) )
        )
    </select>

</mapper>
